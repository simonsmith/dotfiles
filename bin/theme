#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
usage: theme [dark|light|toggle|status]

Examples:
  theme dark
  theme light
  theme toggle
  theme status
EOF
}

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
DOTFILES_DIR="${DOTFILES_DIR:-$SCRIPT_DIR/..}"

XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
THEME_FILE="$XDG_CONFIG_HOME/theme"
TMUX_THEME_FILE="$XDG_CONFIG_HOME/tmux/theme.conf"
ALACRITTY_DIR="$XDG_CONFIG_HOME/alacritty"

ALACRITTY_DARK="$DOTFILES_DIR/alacritty/dark.toml"
ALACRITTY_LIGHT="$DOTFILES_DIR/alacritty/light.toml"

read_mode() {
  if [[ -f "$THEME_FILE" ]]; then
    local mode
    mode="$(tr -d '[:space:]' < "$THEME_FILE")"
    if [[ "$mode" == "light" || "$mode" == "dark" ]]; then
      echo "$mode"
      return
    fi
  fi
  echo "dark"
}

write_tmux_theme() {
  local mode="$1"
  local powerkit_theme powerkit_variant window_inactive window_active popup_bg

  if [[ "$mode" == "light" ]]; then
    powerkit_theme="catppuccin"
    powerkit_variant="latte"
    window_active="#e1e2e7"   # matches alacritty day background
    window_inactive="#e0e0e0" # slightly lighter for inactive panes
    popup_bg="$window_active"
  else
    powerkit_theme="moonlight"
    powerkit_variant="default"
    window_active="#222436"  # matches alacritty moon background
    window_inactive="#2b2f44"
    popup_bg="$window_active"
  fi

  mkdir -p "$(dirname "$TMUX_THEME_FILE")"
  cat > "$TMUX_THEME_FILE" <<EOF
# Generated by ~/bin/theme
set -g @powerkit_theme "$powerkit_theme"
set -g @powerkit_theme_variant "$powerkit_variant"
set -g @theme_popup_bg "$popup_bg"
set -g window-style "bg=$window_inactive"
set -g window-active-style "bg=$window_active"
EOF
}

apply_mode() {
  local mode="$1"

  if [[ "$mode" != "light" && "$mode" != "dark" ]]; then
    echo "Unknown theme: $mode" >&2
    exit 1
  fi

  mkdir -p "$XDG_CONFIG_HOME"
  printf '%s\n' "$mode" > "$THEME_FILE"

  mkdir -p "$ALACRITTY_DIR"
  if [[ "$mode" == "light" ]]; then
    [[ -f "$ALACRITTY_LIGHT" ]] || { echo "Missing: $ALACRITTY_LIGHT" >&2; exit 1; }
    ln -sf "$ALACRITTY_LIGHT" "$ALACRITTY_DIR/active.toml"
  else
    [[ -f "$ALACRITTY_DARK" ]] || { echo "Missing: $ALACRITTY_DARK" >&2; exit 1; }
    ln -sf "$ALACRITTY_DARK" "$ALACRITTY_DIR/active.toml"
  fi

  write_tmux_theme "$mode"

  if tmux ls >/dev/null 2>&1; then
    tmux source-file "$HOME/.tmux.conf" >/dev/null 2>&1 || true
    tmux list-panes -a -F '#{pane_pid} #{pane_current_command}' | while read -r pid cmd; do
      case "$cmd" in
        zsh)
          kill -USR1 "$pid" >/dev/null 2>&1 || true
          ;;
      esac
    done
  fi
}

case "${1:-status}" in
  dark|light)
    apply_mode "$1"
    ;;
  toggle)
    current="$(read_mode)"
    if [[ "$current" == "light" ]]; then
      apply_mode "dark"
    else
      apply_mode "light"
    fi
    ;;
  status)
    read_mode
    ;;
  -h|--help|help)
    usage
    ;;
  *)
    usage
    exit 1
    ;;
esac
